<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        body{
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <textarea name="writeas" id="writehere" cols="30" rows="10"></textarea>
    <script>
        var allowedFileTypes = ["image/png", "image/jpeg"];

        // using getElementsByTagName instead of querySelector for
        // more backward compatibility (and probably performance)
        var dropbox = document.getElementsByTagName("body")[0];
        dropbox.addEventListener("drop", drop, true);
        dropbox.addEventListener("dragover", function(e){e.preventDefault()}, true)
        // TODO: remove focus from the textarea or find a way to get the drop position.
        // because that cursor that appears when you hover while dragging is misleading
        // (firefox only)

        var textarea = document.getElementsByTagName("textarea")[0];

        function drop(e) {
            e.preventDefault(); 
            var files = e.dataTransfer.files;
            for (var i = 0; i < files.length; i++) {
                var file = files[i];
                // from https://stackoverflow.com/a/1818400/400257
                description = file.name.substr(0, file.name.lastIndexOf('.')) || file.name;
                file.identifier = Math.random().toString(36).substring(2, 15);
                remoteFileName = file.identifier;
                markdown = " [" + description + "](" + remoteFileName + ") ";
                insertTextAtCursor(markdown, textarea);
                handleFile(file);
            }
        }

        function insertTextAtCursor(text, textarea){
            if (textarea.nodeName == "TEXTAREA") {
                // save cursor position so that we can set it back after the operation on value
                var startingPosition = textarea.selectionStart;
                var textBeforeCursor = textarea.value.substring(0, textarea.selectionStart);
                var textAfterCursor = textarea.value.substring(textarea.selectionEnd, textarea.value.length);
                textarea.value = textBeforeCursor + text + textAfterCursor;
                // set the cursor to its original position
                textarea.selectionStart = textarea.selectionEnd = startingPosition + text.length;
            } else throw "Element is not a textarea"
        }

        function handleFile(file){
            var ok = false;
            for (var i in allowedFileTypes){
                if (file.type.match(allowedFileTypes[i])) {ok=true; break;}
            }
            if (!ok) throw "disallowed file type";

            // var reader = new FileReader();
            // reader.readAsDataURL(file);
            var xhr = new XMLHttpRequest();
            // progressMgmt(xhr,file,img);
            xhr.open("POST", "upload.php");
            xhr.setRequestHeader("Cache-Control", "no-cache");
            xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
            xhr.setRequestHeader("X-File-Name", file.name);
            xhr.setRequestHeader("X-File-Size", file.size);

            var formData = new FormData();
            formData.append('file', file);
            xhr.send(formData);
            xhr.onreadystatechange = function(){
                if(xhr.readyState == 4){
                    processResponse(xhr.responseText, file.identifier);
                }
            }
        }

        function processResponse(responseText, identifier){
            var response = JSON.parse(responseText);
            textarea.value = textarea.value.replace("("+identifier+")", "("+response.url+")");
        }
    </script>
</body>
</html>